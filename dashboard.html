<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Charger Monitoring Dashboard (Live)</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <header>
        <h1>EV Charger Monitoring Dashboard ðŸ“Š</h1>
        <p>This data updates instantly from the online database!</p>
    </header>
    <div class="container">
        <h2>Key Metrics</h2>
        <div class="metrics">
            <div class="metric-box">
                <p>Chargers Online</p>
                <div class="metric-value" id="chargers-online-count">0</div>
            </div>
            <div class="metric-box">
                <p>Total Power Used (kW)</p>
                <div class="metric-value" id="total-power-used">0.000</div>
            </div>
        </div>

        <h2>Live Charging Sessions</h2>
        <p>This list updates instantly when a new session is started on the <a href="submit.html">Submit Page</a>.</p>
        <table>
            <thead>
                <tr>
                    <th>Vehicle Number</th>
                    <th>Amount Paid (â‚¹)</th>
                    <th>Start Time</th>
                    <th>Action (Simulated)</th>
                </tr>
            </thead>
            <tbody id="charging-sessions-list">
                </tbody>
        </table>
        
        <hr>
        <p>Test by submitting data on the <a href="submit.html">Submit Page</a> and watching this page update.</p>
    </div>

    <script>
        // *** 1. YOUR FIREBASE CONFIGURATION ***
        const firebaseConfig = {
          apiKey: "AIzaSyBEcWgxOWRVKYO6tGCkUtEwPM-yrtOuoOY",
          authDomain: "evchargecontrol.firebaseapp.com",
          databaseURL: "https://evchargecontrol-default-rtdb.firebaseio.com",
          projectId: "evchargecontrol",
          storageBucket: "evchargecontrol.firebasestorage.app",
          messagingSenderId: "509720101839",
          appId: "1:509720101839:web:a2525ee67dbd63de0648ba",
          measurementId: "G-NKKTKNPYPW"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const database = firebase.database();
        const requestsRef = database.ref('requests');
        const sessionList = document.getElementById('charging-sessions-list');

        let powerUpdateInterval; // Global variable to hold the refresh interval ID
        
        // --- LIVE UPDATES FOR CHARGING REQUESTS & METRICS ---
        requestsRef.on('value', (snapshot) => {
            const requestsData = snapshot.val();
            sessionList.innerHTML = ''; // Clear the current list
            let requestsArray = [];

            // Clear any existing interval to prevent multiple running timers
            if (powerUpdateInterval) {
                clearInterval(powerUpdateInterval);
            }

            if (requestsData) {
                // Convert object to array, reverse it so the newest session is at the top.
                requestsArray = Object.entries(requestsData).reverse(); 

                requestsArray.forEach(([key, request]) => {
                    // Create a new row (<tr>) for each request
                    const row = sessionList.insertRow();
                    row.innerHTML = `
                        <td>${request.vehicle_number}</td>
                        <td>â‚¹${request.amount_paid.toFixed(2)}</td>
                        <td>${request.start_time}</td>
                        <td>
                            <button onclick="endSession('${key}')" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">End Session</button>
                        </td>
                    `;
                });
            }
            
            // Update the metrics immediately when the list changes
            updateMetrics(requestsData);

            // Start a new power update interval ONLY if there are active sessions
            if (requestsArray.length > 0) {
                // Set interval to update metrics every 1 second
                powerUpdateInterval = setInterval(() => {
                    // Pass the current data to the update function
                    updateMetrics(requestsData); 
                }, 1000); // 1000 milliseconds = 1 second
            }
        });

        
        /**
         * Function to calculate and update the dynamic metrics (Online Count & Power Used)
         * This function is run every time the database updates AND every 1 second (if active).
         */
        function updateMetrics(requestsData) {
            let onlineCount = 0;
            let totalPower = 0;
            const currentTime = new Date();
            const POWER_RATE_KW_PER_SECOND = 0.001; // 0.001 kW consumed every second

            if (requestsData) {
                onlineCount = Object.keys(requestsData).length;
                
                Object.values(requestsData).forEach(request => {
                    // Convert the stored start_time string back into a Date object
                    const startTime = new Date(request.start_time); 
                    
                    // Calculate elapsed time in milliseconds
                    const timeElapsedMs = currentTime.getTime() - startTime.getTime();
                    
                    // Convert milliseconds to seconds (timeElapsedMs / 1000)
                    const timeElapsedSeconds = timeElapsedMs / 1000;
                    
                    // Calculate cumulative power used for this session
                    const sessionPowerUsed = timeElapsedSeconds * POWER_RATE_KW_PER_SECOND;
                    
                    totalPower += sessionPowerUsed;
                });
            }

            // Update the HTML elements
            document.getElementById('chargers-online-count').textContent = onlineCount;
            document.getElementById('total-power-used').textContent = totalPower.toFixed(3); // Show 3 decimal places
        }


        // Function to simulate ending a session by removing the data
        function endSession(key) {
             if (confirm("Are you sure you want to end this session?")) {
                database.ref('requests/' + key).remove()
                    .then(() => {
                        console.log("Session ended and data removed.");
                    })
                    .catch((error) => {
                        console.error("Failed to remove session: ", error);
                    });
            }
        }
    </script>
</body>
</html>
