<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Charger Monitoring Dashboard (Live)</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <header>
        <h1>EV Charger Monitoring Dashboard ðŸ“Š</h1>
        <p>This data updates instantly from the online database!</p>
    </header>
    <div class="container">
        <h2>Key Metrics</h2>
        <div class="metrics">
            <div class="metric-box">
                <p>Chargers Online</p>
                <div class="metric-value" id="chargers-online-count">0</div>
            </div>
            <div class="metric-box">
                <p>Total Power Used (kW)</p>
                <div class="metric-value" id="total-power-used">0.0</div>
            </div>
        </div>

        <h2>Live Charging Sessions</h2>
        <p>This list updates instantly when a new session is started on the <a href="submit.html">Submit Page</a>.</p>
        <table>
            <thead>
                <tr>
                    <th>Vehicle Number</th>
                    <th>Amount Paid (â‚¹)</th>
                    <th>Start Time</th>
                    <th>Action (Simulated)</th>
                </tr>
            </thead>
            <tbody id="charging-sessions-list">
                </tbody>
        </table>
        
        <hr>
        <p>Test by submitting data on the <a href="submit.html">Submit Page</a> and watching this page update.</p>
    </div>

    <script>
        // *** 1. YOUR FIREBASE CONFIGURATION (Integrated) ***
        const firebaseConfig = {
          apiKey: "AIzaSyBEcWgxOWRVKYO6tGCkUtEwPM-yrtOuoOY",
          authDomain: "evchargecontrol.firebaseapp.com",
          databaseURL: "https://evchargecontrol-default-rtdb.firebaseio.com",
          projectId: "evchargecontrol",
          storageBucket: "evchargecontrol.firebasestorage.app",
          messagingSenderId: "509720101839",
          appId: "1:509720101839:web:a2525ee67dbd63de0648ba",
          measurementId: "G-NKKTKNPYPW"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const database = firebase.database();

        // --- 2. LIVE UPDATES FOR CHARGER STATUS & POWER (The 'chargers' Node) ---
        const chargersRef = database.ref('chargers');
        
        chargersRef.on('value', (snapshot) => {
            const chargersData = snapshot.val();
            let onlineCount = 0;
            let totalPower = 0;

            if (chargersData) {
                // Loop through all charger objects
                Object.values(chargersData).forEach(charger => {
                    if (charger.status === 'online') {
                        onlineCount++;
                        // We assume all online chargers are drawing their full power for this demo
                        totalPower += charger.power_kW; 
                    }
                });
            }

            // Update the HTML elements
            document.getElementById('chargers-online-count').textContent = onlineCount;
            document.getElementById('total-power-used').textContent = totalPower.toFixed(1);
        });


        // --- 3. LIVE UPDATES FOR CHARGING REQUESTS (The 'requests' Node) ---
        const requestsRef = database.ref('requests');
        const sessionList = document.getElementById('charging-sessions-list');

        // 'on' function creates a REAL-TIME listener
        requestsRef.on('value', (snapshot) => {
            const requestsData = snapshot.val();
            sessionList.innerHTML = ''; // Clear the current list

            if (requestsData) {
                // Convert object to array, reverse it so the newest session is at the top.
                const requestsArray = Object.entries(requestsData).reverse(); 

                requestsArray.forEach(([key, request]) => {
                    // Create a new row (<tr>) for each request
                    const row = sessionList.insertRow();
                    row.innerHTML = `
                        <td>${request.vehicle_number}</td>
                        <td>â‚¹${request.amount_paid.toFixed(2)}</td>
                        <td>${request.start_time}</td>
                        <td>
                            <button onclick="endSession('${key}')" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">End Session</button>
                        </td>
                    `;
                });
            }
        });

        // Function to simulate ending a session by removing the data
        function endSession(key) {
             if (confirm("Are you sure you want to end this session?")) {
                // Deletes the entry from the Firebase 'requests' node
                database.ref('requests/' + key).remove() 
                    .then(() => {
                        console.log("Session ended and data removed.");
                        // The dashboard updates automatically due to the 'requestsRef.on' listener!
                    })
                    .catch((error) => {
                        console.error("Failed to remove session: ", error);
                    });
            }
        }
    </script>
</body>
</html>
